# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ GitHub Actions –Ω–∞ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä.

## –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ SSH –∫–ª—é—á–∞ –¥–ª—è –¥–µ–ø–ª–æ—è

–ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ —Å–æ–∑–¥–∞–π SSH –∫–ª—é—á —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –¥–µ–ø–ª–æ—è:

```bash
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/temis_deploy
```

**–í–∞–∂–Ω–æ:** –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –ø–∞—Ä–æ–ª—å –Ω–∞ –∫–ª—é—á (–ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ Enter).

## –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

–°–∫–æ–ø–∏—Ä—É–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä:

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑—É—è ssh-copy-id (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
ssh-copy-id -i ~/.ssh/temis_deploy.pub root@2a03:6f01:1:2::1:f3f5

# –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä—É—á–Ω—É—é
cat ~/.ssh/temis_deploy.pub | ssh root@2a03:6f01:1:2::1:f3f5 "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:

```bash
ssh -i ~/.ssh/temis_deploy root@2a03:6f01:1:2::1:f3f5 "echo 'SSH —Ä–∞–±–æ—Ç–∞–µ—Ç!'"
```

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Secrets

1. –ü–µ—Ä–µ–π–¥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ GitHub:
   - Settings ‚Üí Secrets and variables ‚Üí Actions

2. –î–æ–±–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–µ secrets:

### `SSH_PRIVATE_KEY`
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞:
```bash
cat ~/.ssh/temis_deploy
```
–°–∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å –≤—ã–≤–æ–¥ (–≤–∫–ª—é—á–∞—è `-----BEGIN OPENSSH PRIVATE KEY-----` –∏ `-----END OPENSSH PRIVATE KEY-----`)

### `SERVER_HOST`
–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞:
```
2a03:6f01:1:2::1:f3f5
```

### `SERVER_USER`
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è SSH:
```
root
```

## –®–∞–≥ 4: –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

–ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –¥–µ–ø–ª–æ–µ–º –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä. –í—ã–ø–æ–ª–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@2a03:6f01:1:2::1:f3f5

# –ó–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
bash <(curl -s https://raw.githubusercontent.com/–≤–∞—à-username/temis/master/scripts/setup-server-initial.sh)
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
apt-get update
apt-get install -y python3 python3-pip python3-venv nodejs npm nginx git

# 2. –°–æ–∑–¥–∞–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
mkdir -p /var/www/temis
chown -R www-data:www-data /var/www/temis

# 3. –°–æ–∑–¥–∞–π systemd —Å–µ—Ä–≤–∏—Å—ã (—Å–º. deploy/configs/systemd/)
# 4. –°–æ–∑–¥–∞–π nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (—Å–º. deploy/configs/nginx/)
# 5. –°–æ–∑–¥–∞–π .env —Ñ–∞–π–ª –¥–ª—è –±—ç–∫–µ–Ω–¥–∞ –≤ /var/www/temis/backend/.env
```

## –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ secrets –∏ —Å–µ—Ä–≤–µ—Ä–∞:

1. –°–¥–µ–ª–∞–π –∫–æ–º–º–∏—Ç –∏ –ø—É—à –≤ –≤–µ—Ç–∫—É `master` –∏–ª–∏ `main`
2. GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç –¥–µ–ø–ª–æ–π
3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –¥–µ–ø–ª–æ—è –≤ —Ä–∞–∑–¥–µ–ª–µ Actions –Ω–∞ GitHub

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è

GitHub Actions workflow –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±—ç–∫–µ–Ω–¥ (–º–∏–≥—Ä–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞)
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–ª–∏–Ω—Ç–µ—Ä, —Å–±–æ—Ä–∫–∞)
3. ‚úÖ –°–æ–±–∏—Ä–∞–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (`npm run build`)
4. ‚úÖ –°–æ–∑–¥–∞–µ—Ç –∞—Ä—Ö–∏–≤ —Å —Ñ–∞–π–ª–∞–º–∏
5. ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SSH
6. ‚úÖ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
7. ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
8. ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ Django
9. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç systemd —Å–µ—Ä–≤–∏—Å—ã

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ `~/.ssh/authorized_keys` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `SSH_PRIVATE_KEY` –≤ GitHub Secrets —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Å—å –∫–ª—é—á
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `SERVER_HOST` –∏ `SERVER_USER` —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: `journalctl -u temis-backend -f`
- –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `ls -la /var/www/temis`
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ systemd —Å–µ—Ä–≤–∏—Å—ã —Å–æ–∑–¥–∞–Ω—ã

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—Ä—Ç–∞–º–∏
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã, —Å–æ–æ–±—â–∏ —Ö–æ—Å—Ç–∏–Ω–≥-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—É –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π —Ñ–∞–π—Ä–≤–æ–ª:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤
sudo ufw status
# –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å ufw)
sudo ufw allow 22/tcp
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –±—ç–∫–µ–Ω–¥–∞

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/var/www/temis/backend/.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```env
SECRET_KEY=—Ç–≤–æ–π-—Å–µ–∫—Ä–µ—Ç–Ω—ã–π-–∫–ª—é—á
DEBUG=False
ALLOWED_HOSTS=—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com,api.—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
DATABASE_URL=sqlite:///db.sqlite3
# –ò –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–º–µ–Ω–∞

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –Ω–∞—Å—Ç—Ä–æ–π DNS –∑–∞–ø–∏—Å–∏ –∏ –ø–æ–ª—É—á–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã:

```bash
sudo certbot --nginx -d —Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
sudo certbot --nginx -d api.—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
```

