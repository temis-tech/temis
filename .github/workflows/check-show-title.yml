name: Check show_title on server

on:
  workflow_dispatch:
    inputs:
      slug:
        description: 'Slug —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)'
        required: false
        type: string

jobs:
  check:
    name: Check show_title
    runs-on: ubuntu-latest
    steps:
      - name: Check show_title on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          timeout: 60s
          debug: false
          script: |
            set +x
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º show_title –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
            echo ""
            cd /var/www/temis/backend
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ø—Ä—è–º—É—é
            echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:"
            sudo -u www-data venv/bin/python manage.py check_show_title

            echo ""
            echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ API (—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä):"
            if [ -n "${{ github.event.inputs.slug }}" ]; then
              SLUG="${{ github.event.inputs.slug }}"
              echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ slug: $SLUG"
              sudo -u www-data venv/bin/python manage.py check_show_title --slug "$SLUG"
            else
              echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
              sudo -u www-data venv/bin/python manage.py check_show_title
            fi
            
            echo ""
            echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç API —á–µ—Ä–µ–∑ curl:"
            if [ -n "${{ github.event.inputs.slug }}" ]; then
              SLUG="${{ github.event.inputs.slug }}"
              echo "   –ó–∞–ø—Ä–æ—Å: https://api.temis.ooo/api/content/pages/by-slug/$SLUG/"
              curl -s "https://api.temis.ooo/api/content/pages/by-slug/$SLUG/" | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"show_title –≤ API: {data.get('show_title')} (type: {type(data.get('show_title')).__name__})\")" 2>/dev/null || echo "   –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç API"
            fi

