name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up environment variables
      run: |
        cd backend
        echo "SECRET_KEY=ci-test-secret-key-for-testing-only" >> .env
        echo "DEBUG=False" >> .env
        echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env
        echo "DATABASE_URL=sqlite:///db.sqlite3" >> .env
    
    - name: Run migrations check
      run: |
        cd backend
        python manage.py migrate --check || echo "‚ö†Ô∏è  Migrations check skipped (no database)"
    
    - name: Check Django configuration
      run: |
        cd backend
        python manage.py check --deploy || python manage.py check

  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run linter
      run: |
        cd frontend
        npm run lint
    
    - name: Build
      run: |
        cd frontend
        npm run build

  deploy:
    needs: [backend-tests, frontend-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Build frontend
      run: |
        cd frontend
        npm ci
        NEXT_PUBLIC_API_URL=https://api.dev.logoped-spb.pro/api npm run build
    
    - name: Deploy to server
      run: |
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–µ–ø–ª–æ—è
        DEPLOY_DIR=$(mktemp -d)
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        mkdir -p "${DEPLOY_DIR}/frontend" "${DEPLOY_DIR}/backend"
        
        # Frontend - –∫–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
        # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é frontend, –∏—Å–∫–ª—é—á–∞—è node_modules –∏ .next (–ø–µ—Ä–µ—Å–æ–±–µ—Ä–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        rsync -av --exclude='node_modules' --exclude='.next' --exclude='.git' frontend/ "${DEPLOY_DIR}/frontend/" || {
          # Fallback –Ω–∞ cp –µ—Å–ª–∏ rsync –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
          cp -r frontend/.next "${DEPLOY_DIR}/frontend/" 2>/dev/null || true
          cp -r frontend/public "${DEPLOY_DIR}/frontend/" || true
          cp -r frontend/src "${DEPLOY_DIR}/frontend/" || true
          cp frontend/package*.json "${DEPLOY_DIR}/frontend/" || true
          cp frontend/next.config.js "${DEPLOY_DIR}/frontend/" || true
          cp frontend/tsconfig.json "${DEPLOY_DIR}/frontend/" || true
          cp frontend/next-env.d.ts "${DEPLOY_DIR}/frontend/" 2>/dev/null || true
          cp frontend/.eslintrc.json "${DEPLOY_DIR}/frontend/" 2>/dev/null || true
        }
        
        # Backend - –∫–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        cp -r backend/* "${DEPLOY_DIR}/backend/" || true
        
        # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
        cd "${DEPLOY_DIR}"
        tar -czf /tmp/deploy.tar.gz frontend/ backend/
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp -o StrictHostKeyChecking=no /tmp/deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          SITE_PATH="/var/www/rainbow-say"
          SITE_NAME="rainbow-say"
          
          echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞—é –∞—Ä—Ö–∏–≤..."
          cd /tmp
          sudo tar -xzf deploy.tar.gz -C "${SITE_PATH}"
          
          echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
          sudo chown -R www-data:www-data "${SITE_PATH}"
          sudo chmod -R 755 "${SITE_PATH}"
          
          echo "üîß –û—á–∏—â–∞—é npm –∫—ç—à –∏ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã..."
          sudo rm -rf /var/www/.npm
          sudo mkdir -p /home/www-data/.npm
          sudo chown -R www-data:www-data /home/www-data
          cd "${SITE_PATH}/frontend"
          sudo rm -rf node_modules package-lock.json
          
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è npm –∫—ç—à–∞ –≤ –¥–æ–º–∞—à–Ω–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ www-data
          sudo -u www-data env NPM_CONFIG_CACHE=/home/www-data/.npm npm install --omit=dev || sudo -u www-data env NPM_CONFIG_CACHE=/home/www-data/.npm npm install
          
          echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é Next.js –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
          # –û—á–∏—â–∞–µ–º –∫—ç—à Next.js –∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º
          sudo rm -rf "${SITE_PATH}/frontend/.next/cache" || true
          sudo -u www-data env NPM_CONFIG_CACHE=/home/www-data/.npm NEXT_PUBLIC_API_URL=https://api.dev.logoped-spb.pro/api npm run build
          
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±—ç–∫–µ–Ω–¥–∞..."
          cd "${SITE_PATH}/backend"
          
          if [ ! -d "venv" ]; then
            echo "üêç –°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
            sudo -u www-data python3 -m venv venv
          fi
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è pip –∫—ç—à–∞
          sudo -u www-data env PIP_CACHE_DIR=/home/www-data/.cache/pip ./venv/bin/pip install --upgrade pip
          sudo -u www-data env PIP_CACHE_DIR=/home/www-data/.cache/pip ./venv/bin/pip install -r requirements.txt
          
          echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–∞–≤–∞ –¥–ª—è venv..."
          sudo chown -R www-data:www-data "${SITE_PATH}/backend/venv"
          
          echo "üóÑÔ∏è  –í—ã–ø–æ–ª–Ω—è—é –º–∏–≥—Ä–∞—Ü–∏–∏..."
          if [ -f "${SITE_PATH}/backend/.env" ]; then
            # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–∞—Ö/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö
            sudo -u www-data ./venv/bin/python manage.py migrate --noinput 2>&1 | tee /tmp/migrate.log || {
              # –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–ø–∞–ª–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏–∑-–∑–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
              if grep -q "already exists" /tmp/migrate.log; then
                echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–∫—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—ã—Ç–∞—é—Å—å –ø–æ–º–µ—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é..."
                # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
                sudo -u www-data ./venv/bin/python manage.py migrate --fake content 0024 2>/dev/null || true
                # –ü–æ–≤—Ç–æ—Ä—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
                sudo -u www-data ./venv/bin/python manage.py migrate --noinput || true
              fi
            }
            sudo -u www-data ./venv/bin/python manage.py collectstatic --noinput || true
          fi
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
          sudo systemctl restart ${SITE_NAME}-frontend || echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å frontend –Ω–µ –Ω–∞–π–¥–µ–Ω"
          sudo systemctl restart ${SITE_NAME}-backend || echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å backend –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é nginx..."
          sudo systemctl reload nginx || sudo systemctl restart nginx || echo "‚ö†Ô∏è  Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "üßπ –û—á–∏—â–∞—é –∫—ç—à Next.js..."
          sudo rm -rf "${SITE_PATH}/frontend/.next/cache" || true
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
          rm -f /tmp/deploy.tar.gz
        ENDSSH
        
        # –û—á–∏—Å—Ç–∫–∞
        rm -rf "${DEPLOY_DIR}"
        rm -f /tmp/deploy.tar.gz

