name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up environment variables
      run: |
        cd backend
        echo "SECRET_KEY=ci-test-secret-key-for-testing-only" >> .env
        echo "DEBUG=False" >> .env
        echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env
        echo "DATABASE_URL=sqlite:///db.sqlite3" >> .env
    
    - name: Run migrations check
      run: |
        cd backend
        python manage.py migrate --check || echo "‚ö†Ô∏è  Migrations check skipped (no database)"
    
    - name: Check Django configuration
      run: |
        cd backend
        python manage.py check --deploy || python manage.py check

  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run linter
      run: |
        cd frontend
        npm run lint
    
    - name: Build
      run: |
        cd frontend
        npm run build

  deploy:
    needs: [backend-tests, frontend-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Build frontend
      run: |
        cd frontend
        npm ci
        npm run build
    
    - name: Deploy to server
      run: |
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–µ–ø–ª–æ—è
        DEPLOY_DIR=$(mktemp -d)
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        mkdir -p "${DEPLOY_DIR}/frontend" "${DEPLOY_DIR}/backend"
        
        # Frontend - –∫–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏
        cp -r frontend/.next "${DEPLOY_DIR}/frontend/" || true
        cp -r frontend/public "${DEPLOY_DIR}/frontend/" || true
        cp -r frontend/src "${DEPLOY_DIR}/frontend/" || true
        cp frontend/package*.json "${DEPLOY_DIR}/frontend/" || true
        cp frontend/next.config.js "${DEPLOY_DIR}/frontend/" || true
        cp frontend/tsconfig.json "${DEPLOY_DIR}/frontend/" || true
        
        # Backend - –∫–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        cp -r backend/* "${DEPLOY_DIR}/backend/" || true
        
        # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
        cd "${DEPLOY_DIR}"
        tar -czf /tmp/deploy.tar.gz frontend/ backend/
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp -o StrictHostKeyChecking=no /tmp/deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          SITE_PATH="/var/www/rainbow-say"
          SITE_NAME="rainbow-say"
          
          echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞—é –∞—Ä—Ö–∏–≤..."
          cd /tmp
          sudo tar -xzf deploy.tar.gz -C "${SITE_PATH}"
          
          echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
          sudo chown -R www-data:www-data "${SITE_PATH}"
          sudo chmod -R 755 "${SITE_PATH}"
          
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
          cd "${SITE_PATH}/frontend"
          sudo -u www-data npm install --omit=dev || sudo -u www-data npm install
          
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±—ç–∫–µ–Ω–¥–∞..."
          cd "${SITE_PATH}/backend"
          
          if [ ! -d "venv" ]; then
            echo "üêç –°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
            sudo -u www-data python3 -m venv venv
          fi
          
          sudo -u www-data ./venv/bin/pip install --upgrade pip
          sudo -u www-data ./venv/bin/pip install -r requirements.txt
          
          echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–∞–≤–∞ –¥–ª—è venv..."
          sudo chown -R www-data:www-data "${SITE_PATH}/backend/venv"
          
          echo "üóÑÔ∏è  –í—ã–ø–æ–ª–Ω—è—é –º–∏–≥—Ä–∞—Ü–∏–∏..."
          if [ -f "${SITE_PATH}/backend/.env" ]; then
            sudo -u www-data ./venv/bin/python manage.py migrate --noinput || true
            sudo -u www-data ./venv/bin/python manage.py collectstatic --noinput || true
          fi
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
          sudo systemctl restart ${SITE_NAME}-frontend || echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å frontend –Ω–µ –Ω–∞–π–¥–µ–Ω"
          sudo systemctl restart ${SITE_NAME}-backend || echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å backend –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
          rm -f /tmp/deploy.tar.gz
        ENDSSH
        
        # –û—á–∏—Å—Ç–∫–∞
        rm -rf "${DEPLOY_DIR}"
        rm -f /tmp/deploy.tar.gz

