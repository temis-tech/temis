name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  frontend:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run linter
        working-directory: ./frontend
        run: npm run lint
      
      - name: Build
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production

  backend:
    name: Backend (Django)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: './backend/requirements.txt'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      
      - name: Check for pending migrations
        working-directory: ./backend
        run: |
          python manage.py makemigrations --check --dry-run
        env:
          DJANGO_SETTINGS_MODULE: config.settings
          SECRET_KEY: 'ci-test-secret-key-for-testing-only'
          DEBUG: 'False'
          ALLOWED_HOSTS: 'localhost,127.0.0.1'
          USE_SQLITE: 'True'
      
      - name: Run Django check
        working-directory: ./backend
        run: |
          python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: config.settings
          SECRET_KEY: 'ci-test-secret-key-for-testing-only'
          DEBUG: 'False'
          ALLOWED_HOSTS: 'localhost,127.0.0.1'
          USE_SQLITE: 'True'

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: always()
    steps:
      - name: Check CI results
        id: check_results
        run: |
          if [ "${{ needs.frontend.result }}" != "success" ] || [ "${{ needs.backend.result }}" != "success" ]; then
            echo "‚ùå CI failed: frontend=${{ needs.frontend.result }}, backend=${{ needs.backend.result }}"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ All CI checks passed"
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Send Telegram notification on success
        if: steps.check_results.outputs.status == 'success'
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          MESSAGE="‚úÖ <b>CI —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
      
      - name: Send Telegram notification on failure
        if: failure()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          FRONTEND_STATUS="${{ needs.frontend.result }}"
          BACKEND_STATUS="${{ needs.backend.result }}"
          MESSAGE="‚ùå <b>CI –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A%0Aüìä –°—Ç–∞—Ç—É—Å:%0A‚Ä¢ Frontend: ${FRONTEND_STATUS}%0A‚Ä¢ Backend: ${BACKEND_STATUS}%0A%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
