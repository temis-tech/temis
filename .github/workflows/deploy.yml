name: Deploy Temis to Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: deploy-temis-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Temis to Production
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.workflow_run.head_branch }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: './backend/requirements.txt'
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      
      - name: Check Django
        working-directory: ./backend
        run: python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: config.settings
          USE_SQLITE: 'True'
      
      - name: Create deployment archive
        run: |
          echo "üì¶ Creating deployment archive..."
          
          # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º frontend (standalone —Ä–µ–∂–∏–º)
          cd frontend
          tar -czf ../frontend-deploy.tar.gz \
            .next/standalone \
            .next/static \
            public \
            package.json \
            next.config.js
          cd ..
          
          # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º backend
          tar -czf backend-deploy.tar.gz \
            backend \
            deploy/configs
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤
          tar -czf deploy.tar.gz frontend-deploy.tar.gz backend-deploy.tar.gz
          rm frontend-deploy.tar.gz backend-deploy.tar.gz
          echo "‚úÖ Archive created: $(du -h deploy.tar.gz | cut -f1)"
      
      - name: Check secrets
        run: |
          if [ -z "${{ secrets.PROD_SERVER_HOST }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_HOST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_USER }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_PASSWORD }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
      
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
      
      - name: Upload archive via SCP
        env:
          SSHPASS: ${{ secrets.PROD_SERVER_PASSWORD }}
        run: |
          echo "üì§ Uploading deploy.tar.gz to server..."
          sshpass -e scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            deploy.tar.gz ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/tmp/temis-deploy.tar.gz
      
      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          debug: true
          script: |
            set -e
            
            DEPLOY_DIR="/var/www/temis"
            BACKEND_DIR="$DEPLOY_DIR/backend"
            FRONTEND_DIR="$DEPLOY_DIR/frontend"
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Temis..."
            echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ù–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º Este N√≥mada –≤ /var/www/estenomada"
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
            if [ -d "$DEPLOY_DIR" ]; then
              echo "üì¶ –°–æ–∑–¥–∞—é –±—ç–∫–∞–ø..."
              sudo tar -czf /tmp/temis-backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_DIR . 2>/dev/null || true
            fi
            
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
            echo "üì• –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
            sudo mkdir -p $DEPLOY_DIR
            sudo mkdir -p $FRONTEND_DIR
            sudo mkdir -p $BACKEND_DIR
            cd /tmp
            sudo tar -xzf temis-deploy.tar.gz
            sudo tar -xzf frontend-deploy.tar.gz -C $FRONTEND_DIR
            sudo tar -xzf backend-deploy.tar.gz -C $DEPLOY_DIR
            sudo rm -f temis-deploy.tar.gz frontend-deploy.tar.gz backend-deploy.tar.gz
            echo "‚úÖ –ö–æ–¥ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞..."
            sudo chown -R www-data:www-data $DEPLOY_DIR
            sudo find $DEPLOY_DIR -type d -exec chmod 755 {} \;
            sudo find $DEPLOY_DIR -type f -exec chmod 644 {} \;
            sudo chmod +x $DEPLOY_DIR/scripts/*.sh 2>/dev/null || true
            
            # Backend: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd $BACKEND_DIR
            
            PYTHON_CMD=$(which python3.11 || which python3 || which python)
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º Python: $PYTHON_CMD"
            
            # –°–æ–∑–¥–∞–µ–º venv –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -d "venv" ]; then
              echo "–°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              sudo -u www-data $PYTHON_CMD -m venv venv
            fi
            sudo chmod +x venv/bin/* 2>/dev/null || true
            sudo chown -R www-data:www-data venv
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            sudo -u www-data venv/bin/python -m pip install --upgrade pip
            sudo -u www-data venv/bin/python -m pip install --no-cache-dir -r requirements.txt
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ Django..."
            set +e
            sudo -u www-data venv/bin/python manage.py migrate --noinput 2>&1 || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π"
            set -e
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
            echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É Django..."
            sudo -u www-data venv/bin/python manage.py collectstatic --noinput || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ collectstatic"
            
            # Frontend: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .next/standalone
            echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º Frontend (standalone —Ä–µ–∂–∏–º)..."
            cd $FRONTEND_DIR
            
            if [ ! -d ".next/standalone" ]; then
              echo "‚ö†Ô∏è  .next/standalone –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              exit 1
            fi
            
            # –í standalone —Ä–µ–∂–∏–º–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ .next/standalone
            # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ server.js
            if [ ! -f ".next/standalone/server.js" ]; then
              echo "‚ö†Ô∏è  server.js –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ standalone!"
              exit 1
            fi
            echo "‚úÖ Frontend –≥–æ—Ç–æ–≤ (standalone —Ä–µ–∂–∏–º)"
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            set +e
            
            if systemctl list-unit-files | grep -q temis-backend; then
              sudo systemctl restart temis-backend
              echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å temis-backend –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é"
            fi
            
            if systemctl list-unit-files | grep -q temis-frontend; then
              sudo systemctl restart temis-frontend
              echo "‚úÖ Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å temis-frontend –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é"
            fi
            set -e
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
            echo "üåê –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx..."
            if [ -f "$DEPLOY_DIR/deploy/configs/nginx/temis.conf" ]; then
              echo "üìã –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx..."
              sudo cp $DEPLOY_DIR/deploy/configs/nginx/temis.conf /etc/nginx/sites-available/temis.conf
              
              # –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
              if [ ! -L /etc/nginx/sites-enabled/temis.conf ]; then
                echo "üîó –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è temis.conf..."
                sudo ln -s /etc/nginx/sites-available/temis.conf /etc/nginx/sites-enabled/temis.conf
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
              if sudo nginx -t; then
                echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
              else
                echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            fi
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx..."
            sudo systemctl reload nginx
            echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sudo systemctl status temis-backend --no-pager -l | head -10 || true
            sudo systemctl status temis-frontend --no-pager -l | head -10 || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Este N√≥mada –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Este N√≥mada –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç..."
            if systemctl is-active --quiet estenomada-frontend; then
              echo "‚úÖ Este N√≥mada frontend —Ä–∞–±–æ—Ç–∞–µ—Ç"
            fi
            if systemctl is-active --quiet estenomada-backend; then
              echo "‚úÖ Este N√≥mada backend —Ä–∞–±–æ—Ç–∞–µ—Ç"
            fi
            
            echo "‚úÖ –î–µ–ø–ª–æ–π Temis –∑–∞–≤–µ—Ä—à–µ–Ω!"
      
      - name: Send Telegram notification on success
        if: success()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          MESSAGE="‚úÖ <b>–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüåê –î–æ–º–µ–Ω: temis.ooo%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
      
      - name: Send Telegram notification on failure
        if: failure()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          MESSAGE="‚ùå <b>–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüåê –î–æ–º–µ–Ω: temis.ooo%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A%0A‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
      
      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz

