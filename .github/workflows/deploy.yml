name: Deploy Temis to Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

concurrency:
  # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≤–µ—Ç–∫–µ, —á—Ç–æ–±—ã –¥–µ–ø–ª–æ–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ç–æ–∫ –Ω–µ –º–µ—à–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥—É
  group: deploy-temis-${{ github.event_name == 'workflow_dispatch' && github.ref_name || github.event.workflow_run.head_branch || 'default' }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Temis to Production
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))
    steps:
      - name: Verify CI success
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "‚ùå CI –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          fi
          if [ "${{ github.event.workflow_run.head_branch }}" != "main" ] && [ "${{ github.event.workflow_run.head_branch }}" != "master" ]; then
            echo "‚ùå CI –∑–∞–ø—É—â–µ–Ω –Ω–µ –∏–∑ main/master –≤–µ—Ç–∫–∏: ${{ github.event.workflow_run.head_branch }}"
            exit 1
          fi
          echo "‚úÖ CI —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è –≤–µ—Ç–∫–∏ ${{ github.event.workflow_run.head_branch }}"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.workflow_run.head_branch }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: './backend/requirements.txt'
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      
      - name: Check Django
        working-directory: ./backend
        run: python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: config.settings
          USE_SQLITE: 'True'
      
      - name: Create deployment archive
        run: |
          echo "üì¶ Creating deployment archive..."
          
          # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º frontend (standalone —Ä–µ–∂–∏–º)
          cd frontend
          tar -czf ../frontend-deploy.tar.gz \
            .next/standalone \
            .next/static \
            public \
            package.json \
            next.config.js
          cd ..
          
          # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º backend
          tar -czf backend-deploy.tar.gz \
            backend \
            deploy/configs \
            deploy/apply-nginx-config.sh
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤
          tar -czf deploy.tar.gz frontend-deploy.tar.gz backend-deploy.tar.gz
          rm frontend-deploy.tar.gz backend-deploy.tar.gz
          echo "‚úÖ Archive created: $(du -h deploy.tar.gz | cut -f1)"
      
      - name: Check secrets
        run: |
          if [ -z "${{ secrets.PROD_SERVER_HOST }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_HOST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_USER }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_PASSWORD }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
      
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
      
      - name: Upload archive via SCP
        env:
          SSHPASS: ${{ secrets.PROD_SERVER_PASSWORD }}
        run: |
          echo "üì§ Uploading deploy.tar.gz to server..."
          sshpass -e scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            deploy.tar.gz ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/tmp/temis-deploy.tar.gz
      
      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          debug: true
          script: |
            set -e
            
            DEPLOY_DIR="/var/www/temis"
            BACKEND_DIR="$DEPLOY_DIR/backend"
            FRONTEND_DIR="$DEPLOY_DIR/frontend"
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Temis..."
            echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ù–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º Este N√≥mada –≤ /var/www/estenomada"
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
            if [ -d "$DEPLOY_DIR" ]; then
              echo "üì¶ –°–æ–∑–¥–∞—é –±—ç–∫–∞–ø..."
              sudo tar -czf /tmp/temis-backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_DIR . 2>/dev/null || true
            fi
            
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
            echo "üì• –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
            sudo mkdir -p $DEPLOY_DIR
            sudo mkdir -p $FRONTEND_DIR
            sudo mkdir -p $BACKEND_DIR
            cd /tmp
            sudo tar -xzf temis-deploy.tar.gz
            sudo tar -xzf frontend-deploy.tar.gz -C $FRONTEND_DIR
            sudo tar -xzf backend-deploy.tar.gz -C $DEPLOY_DIR
            sudo rm -f temis-deploy.tar.gz frontend-deploy.tar.gz backend-deploy.tar.gz
            echo "‚úÖ –ö–æ–¥ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞..."
            sudo chown -R www-data:www-data $DEPLOY_DIR
            sudo find $DEPLOY_DIR -type d -exec chmod 755 {} \;
            sudo find $DEPLOY_DIR -type f -exec chmod 644 {} \;
            sudo chmod +x $DEPLOY_DIR/scripts/*.sh 2>/dev/null || true
            
            # Backend: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd $BACKEND_DIR
            
            PYTHON_CMD=$(which python3.11 || which python3 || which python)
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º Python: $PYTHON_CMD"
            
            # –°–æ–∑–¥–∞–µ–º venv –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -d "venv" ]; then
              echo "–°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              sudo -u www-data $PYTHON_CMD -m venv venv
            fi
            sudo chmod +x venv/bin/* 2>/dev/null || true
            sudo chown -R www-data:www-data venv
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            sudo -u www-data venv/bin/python -m pip install --upgrade pip
            sudo -u www-data venv/bin/python -m pip install --no-cache-dir -r requirements.txt
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ Django..."
            set +e
            sudo -u www-data venv/bin/python manage.py migrate --noinput 2>&1 || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π"
            set -e
            
            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -f "$BACKEND_DIR/.env" ]; then
              echo "üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
              SECRET_KEY=$(sudo -u www-data venv/bin/python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')
              sudo -u www-data tee $BACKEND_DIR/.env > /dev/null << ENV_EOF
SECRET_KEY=${SECRET_KEY}
DEBUG=False
ALLOWED_HOSTS=temis.ooo,api.temis.ooo,localhost,127.0.0.1
DATABASE_URL=sqlite:///${BACKEND_DIR}/db.sqlite3
USE_SQLITE=True
ENV_EOF
              sudo chmod 600 $BACKEND_DIR/.env
              echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"
            else
              echo "‚úÖ .env —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            fi
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
            echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É Django..."
            sudo -u www-data venv/bin/python manage.py collectstatic --noinput || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ collectstatic"
            
            # Frontend: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .next/standalone –∏ .next/static
            echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º Frontend (standalone —Ä–µ–∂–∏–º)..."
            cd $FRONTEND_DIR
            
            if [ ! -d ".next/standalone" ]; then
              echo "‚ö†Ô∏è  .next/standalone –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
            if [ ! -d ".next/static" ]; then
              echo "‚ö†Ô∏è  .next/static –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              echo "–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞!"
              exit 1
            fi
            
            # –í standalone —Ä–µ–∂–∏–º–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ .next/standalone
            # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ server.js
            if [ ! -f ".next/standalone/server.js" ]; then
              echo "‚ö†Ô∏è  server.js –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ standalone!"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã
            STATIC_COUNT=$(find .next/static -type f | wc -l)
            if [ "$STATIC_COUNT" -eq 0 ]; then
              echo "‚ö†Ô∏è  –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ .next/static!"
              exit 1
            fi
            echo "‚úÖ Frontend –≥–æ—Ç–æ–≤ (standalone —Ä–µ–∂–∏–º, –Ω–∞–π–¥–µ–Ω–æ $STATIC_COUNT —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤)"
            
            # –°–æ–∑–¥–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            echo "‚öôÔ∏è  –°–æ–∑–¥–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å—ã..."
            set +e
            
            if ! systemctl list-unit-files | grep -q temis-backend; then
              echo "üì¶ –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å temis-backend..."
              sudo tee /etc/systemd/system/temis-backend.service > /dev/null << 'EOF'
[Unit]
Description=Temis Django Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/temis/backend
Environment="PATH=/var/www/temis/backend/venv/bin"
EnvironmentFile=-/var/www/temis/backend/.env
ExecStart=/var/www/temis/backend/venv/bin/gunicorn \
    --bind 127.0.0.1:8001 \
    --workers 1 \
    --threads 2 \
    --timeout 120 \
    --worker-class gthread \
    --max-requests 1000 \
    --max-requests-jitter 50 \
    --access-logfile /var/log/temis-backend-access.log \
    --error-logfile /var/log/temis-backend-error.log \
    config.wsgi:application
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
              sudo systemctl daemon-reload
              sudo systemctl enable temis-backend
              echo "‚úÖ –°–µ—Ä–≤–∏—Å temis-backend —Å–æ–∑–¥–∞–Ω –∏ –≤–∫–ª—é—á–µ–Ω"
            fi
            
            if ! systemctl list-unit-files | grep -q temis-frontend; then
              echo "üì¶ –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å temis-frontend..."
              sudo tee /etc/systemd/system/temis-frontend.service > /dev/null << 'EOF'
[Unit]
Description=Temis Next.js Frontend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/temis/frontend
Environment=NODE_ENV=production
Environment=PORT=3001
ExecStart=/usr/bin/node /var/www/temis/frontend/.next/standalone/server.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
              sudo systemctl daemon-reload
              sudo systemctl enable temis-frontend
              echo "‚úÖ –°–µ—Ä–≤–∏—Å temis-frontend —Å–æ–∑–¥–∞–Ω –∏ –≤–∫–ª—é—á–µ–Ω"
            fi
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            if systemctl list-unit-files | grep -q temis-backend; then
              sudo systemctl restart temis-backend
              echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            fi
            
            if systemctl list-unit-files | grep -q temis-frontend; then
              sudo systemctl restart temis-frontend
              echo "‚úÖ Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            fi
            set -e
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
            echo "üåê –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx..."
            if [ -f "$DEPLOY_DIR/deploy/configs/nginx/temis.conf" ]; then
              echo "üìã –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx..."
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
              SSL_TEMIS_EXISTS=false
              SSL_API_EXISTS=false
              
              if [ -f "/etc/letsencrypt/live/temis.ooo/fullchain.pem" ] && [ -f "/etc/letsencrypt/live/temis.ooo/privkey.pem" ]; then
                SSL_TEMIS_EXISTS=true
                echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è temis.ooo –Ω–∞–π–¥–µ–Ω"
              else
                echo "‚ö†Ô∏è  SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è temis.ooo –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è HTTP"
              fi
              
              if [ -f "/etc/letsencrypt/live/api.temis.ooo/fullchain.pem" ] && [ -f "/etc/letsencrypt/live/api.temis.ooo/privkey.pem" ]; then
                SSL_API_EXISTS=true
                echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è api.temis.ooo –Ω–∞–π–¥–µ–Ω"
              else
                echo "‚ö†Ô∏è  SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è api.temis.ooo –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è HTTP"
              fi
              
              # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑ SSL –µ—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–µ—Ç
              if [ "$SSL_TEMIS_EXISTS" = false ] || [ "$SSL_API_EXISTS" = false ]; then
                echo "üìù –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
                sudo tee /etc/nginx/sites-available/temis.conf > /dev/null << 'NGINX_EOF'
# HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è temis.ooo (–≤—Ä–µ–º–µ–Ω–Ω–∞—è, –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è SSL)
server {
    listen 80;
    listen [::]:80;
    server_name temis.ooo;

    # –õ–æ–≥–∏
    access_log /var/log/nginx/temis_access.log;
    error_log /var/log/nginx/temis_error.log;

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
    client_max_body_size 20M;

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Next.js
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã Next.js
    location /_next/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
    
    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ API (–Ω–∞–ø—Ä—è–º—É—é –Ω–∞ backend)
    location /media/ {
        proxy_pass http://127.0.0.1:8001/media/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public";
    }
}

# HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è api.temis.ooo (–≤—Ä–µ–º–µ–Ω–Ω–∞—è, –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è SSL)
server {
    listen 80;
    listen [::]:80;
    server_name api.temis.ooo;

    # –õ–æ–≥–∏
    access_log /var/log/nginx/temis-api_access.log;
    error_log /var/log/nginx/temis-api_error.log;

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
    client_max_body_size 20M;

    # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã Django
    location /static/ {
        alias /var/www/temis/backend/staticfiles/;
        expires 30d;
        add_header Cache-Control "public";
    }

    # –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã Django
    location /media/ {
        alias /var/www/temis/backend/media/;
        expires 30d;
        add_header Cache-Control "public";
    }

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Django
    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
NGINX_EOF
              else
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å SSL
                sudo cp $DEPLOY_DIR/deploy/configs/nginx/temis.conf /etc/nginx/sites-available/temis.conf
              fi
              
              # –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
              if [ ! -L /etc/nginx/sites-enabled/temis.conf ]; then
                echo "üîó –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è temis.conf..."
                sudo ln -s /etc/nginx/sites-available/temis.conf /etc/nginx/sites-enabled/temis.conf
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
              if sudo nginx -t; then
                echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
              else
                echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            fi
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx..."
            sudo systemctl reload nginx
            echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sudo systemctl status temis-backend --no-pager -l | head -10 || true
            sudo systemctl status temis-frontend --no-pager -l | head -10 || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Este N√≥mada –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Este N√≥mada –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç..."
            if systemctl is-active --quiet estenomada-frontend; then
              echo "‚úÖ Este N√≥mada frontend —Ä–∞–±–æ—Ç–∞–µ—Ç"
            fi
            if systemctl is-active --quiet estenomada-backend; then
              echo "‚úÖ Este N√≥mada backend —Ä–∞–±–æ—Ç–∞–µ—Ç"
            fi
            
            echo "‚úÖ –î–µ–ø–ª–æ–π Temis –∑–∞–≤–µ—Ä—à–µ–Ω!"
      
      - name: Send Telegram notification on success
        if: success()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          MESSAGE="‚úÖ <b>–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüåê –î–æ–º–µ–Ω: temis.ooo%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
      
      - name: Send Telegram notification on failure
        if: failure()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          MESSAGE="‚ùå <b>–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüåê –î–æ–º–µ–Ω: temis.ooo%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A%0A‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
      
      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz

