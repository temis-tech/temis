name: Deploy Temis to Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

concurrency:
  # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≤–µ—Ç–∫–µ, —á—Ç–æ–±—ã –¥–µ–ø–ª–æ–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ç–æ–∫ –Ω–µ –º–µ—à–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥—É
  group: deploy-temis-${{ github.event_name == 'workflow_dispatch' && github.ref_name || github.event.workflow_run.head_branch || 'default' }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Temis to Production
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))
    steps:
      - name: Verify CI success
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "‚ùå CI –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          fi
          if [ "${{ github.event.workflow_run.head_branch }}" != "main" ] && [ "${{ github.event.workflow_run.head_branch }}" != "master" ]; then
            echo "‚ùå CI –∑–∞–ø—É—â–µ–Ω –Ω–µ –∏–∑ main/master –≤–µ—Ç–∫–∏: ${{ github.event.workflow_run.head_branch }}"
            exit 1
          fi
          echo "‚úÖ CI —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è –≤–µ—Ç–∫–∏ ${{ github.event.workflow_run.head_branch }}"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.workflow_run.head_branch }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
          NEXT_PUBLIC_API_URL: https://api.temis.ooo/api
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: './backend/requirements.txt'
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      
      - name: Check Django
        working-directory: ./backend
        run: python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: config.settings
          USE_SQLITE: 'True'
      
      - name: Create deployment archive
        run: |
          echo "üì¶ Creating deployment archive..."
          
          # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º frontend (standalone —Ä–µ–∂–∏–º)
          cd frontend
          tar -czf ../frontend-deploy.tar.gz \
            .next/standalone \
            .next/static \
            public \
            package.json \
            next.config.js
          cd ..
          
          # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º backend
          tar -czf backend-deploy.tar.gz \
            backend \
            deploy/configs \
            deploy/apply-nginx-config.sh \
            deploy/fix-server.sh
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤
          tar -czf deploy.tar.gz frontend-deploy.tar.gz backend-deploy.tar.gz
          rm frontend-deploy.tar.gz backend-deploy.tar.gz
          echo "‚úÖ Archive created: $(du -h deploy.tar.gz | cut -f1)"
      
      - name: Check secrets
        run: |
          if [ -z "${{ secrets.PROD_SERVER_HOST }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_HOST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_USER }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_PASSWORD }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
      
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
      
      - name: Upload archive via SCP
        env:
          SSHPASS: ${{ secrets.PROD_SERVER_PASSWORD }}
        run: |
          echo "üì§ Uploading deploy.tar.gz to server..."
          sshpass -e scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            deploy.tar.gz ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/tmp/temis-deploy.tar.gz
      
      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          debug: false
          script: |
            set -e
            set +x  # –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥ –≤ –ª–æ–≥ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ–≤
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è heredoc –≤ YAML
            
            DEPLOY_DIR="/var/www/temis"
            BACKEND_DIR="$DEPLOY_DIR/backend"
            FRONTEND_DIR="$DEPLOY_DIR/frontend"
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Temis..."
            echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ù–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º Este N√≥mada –≤ /var/www/estenomada"
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
            if [ -d "$DEPLOY_DIR" ]; then
              echo "üì¶ –°–æ–∑–¥–∞—é –±—ç–∫–∞–ø..."
              sudo tar -czf /tmp/temis-backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_DIR . 2>/dev/null || true
            fi
            
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
            echo "üì• –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
            sudo mkdir -p $DEPLOY_DIR
            sudo mkdir -p $FRONTEND_DIR
            sudo mkdir -p $BACKEND_DIR
            cd /tmp
            sudo tar -xzf temis-deploy.tar.gz
            sudo tar -xzf frontend-deploy.tar.gz -C $FRONTEND_DIR
            sudo tar -xzf backend-deploy.tar.gz -C $DEPLOY_DIR
            sudo rm -f temis-deploy.tar.gz frontend-deploy.tar.gz backend-deploy.tar.gz
            echo "‚úÖ –ö–æ–¥ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞..."
            sudo chown -R www-data:www-data $DEPLOY_DIR
            sudo find $DEPLOY_DIR -type d -exec chmod 755 {} \;
            sudo find $DEPLOY_DIR -type f -exec chmod 644 {} \;
            sudo chmod +x $DEPLOY_DIR/scripts/*.sh 2>/dev/null || true
            sudo chmod +x $DEPLOY_DIR/deploy/*.sh 2>/dev/null || true
            
            # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è Python –∏ gunicorn
            if [ -d "$BACKEND_DIR/venv" ]; then
              sudo chmod +x $BACKEND_DIR/venv/bin/python
              sudo chmod +x $BACKEND_DIR/venv/bin/gunicorn
              sudo chmod +x $BACKEND_DIR/venv/bin/* 2>/dev/null || true
              echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ Python/gunicorn —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            fi
            
            # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∞–≤–∞ –Ω–∞ frontend server.js –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é standalone
            if [ -d "$FRONTEND_DIR/.next/standalone" ]; then
              sudo chown -R www-data:www-data "$FRONTEND_DIR/.next/standalone"
              sudo chmod +x "$FRONTEND_DIR/.next/standalone/server.js" 2>/dev/null || true
              echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ standalone –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ node_modules –≤ standalone
              if [ ! -d "$FRONTEND_DIR/.next/standalone/node_modules" ]; then
                echo "‚ö†Ô∏è  node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ standalone, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
                ls -la "$FRONTEND_DIR/.next/standalone/" | head -20
              fi
            else
              echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next/standalone –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É .next:"
              ls -la "$FRONTEND_DIR/.next/" 2>/dev/null || echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
            fi
            
            # –ö–†–ò–¢–ò–ß–ù–û: –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏
            echo "üîó –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ Next.js..."
            if [ -d "$FRONTEND_DIR/.next/standalone/.next" ] && [ -d "$FRONTEND_DIR/.next/static" ]; then
              cd "$FRONTEND_DIR/.next/standalone/.next"
              sudo rm -rf static 2>/dev/null || true
              sudo ln -sf ../../static static
              echo "‚úÖ –°–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω: .next/standalone/.next/static -> ../../static"
              cd "$FRONTEND_DIR"
            else
              echo "‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏–º–ª–∏–Ω–∫–∞"
            fi
            
            # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ë–î
            sudo mkdir -p $(dirname "$BACKEND_DIR/db.sqlite3")
            sudo chown -R www-data:www-data $BACKEND_DIR
            if [ -f "$BACKEND_DIR/db.sqlite3" ]; then
              sudo chown www-data:www-data "$BACKEND_DIR/db.sqlite3"
              sudo chmod 664 "$BACKEND_DIR/db.sqlite3"
              echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            fi
            
            # Backend: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd $BACKEND_DIR
            
            PYTHON_CMD=$(which python3.11 || which python3 || which python)
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º Python: $PYTHON_CMD"
            
            # –°–æ–∑–¥–∞–µ–º venv –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -d "venv" ]; then
              echo "–°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              sudo -u www-data $PYTHON_CMD -m venv venv
            fi
            sudo chmod +x venv/bin/* 2>/dev/null || true
            sudo chown -R www-data:www-data venv
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è MySQL (–Ω—É–∂–Ω—ã –¥–ª—è mysqlclient)
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è MySQL..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq default-libmysqlclient-dev pkg-config || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ MySQL"
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            sudo -u www-data venv/bin/python -m pip install --upgrade pip
            sudo -u www-data venv/bin/python -m pip install --no-cache-dir -r requirements.txt
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã
            echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            sudo systemctl stop temis-frontend 2>/dev/null || true
            sudo systemctl stop temis-backend 2>/dev/null || true
            sudo systemctl reset-failed temis-frontend 2>/dev/null || true
            sudo systemctl reset-failed temis-backend 2>/dev/null || true
            sleep 2
            
            echo "üßπ –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã 3001/8001..."
            # –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤
            for PORT in 3001 8001; do
              echo "   –û—á–∏—â–∞–µ–º –ø–æ—Ä—Ç $PORT..."
              # –ú–µ—Ç–æ–¥ 1: —á–µ—Ä–µ–∑ ss
              PIDS=$(sudo ss -ltnp 2>/dev/null | awk "/:$PORT/" | sed -nE 's/.*pid=([0-9]+).*/\1/p' | sort -u)
              # –ú–µ—Ç–æ–¥ 2: —á–µ—Ä–µ–∑ lsof (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
              if command -v lsof >/dev/null 2>&1; then
                LSOF_PIDS=$(sudo lsof -ti:$PORT 2>/dev/null || true)
                if [ -n "$LSOF_PIDS" ]; then
                  PIDS="$PIDS $LSOF_PIDS"
                fi
              fi
              # –ú–µ—Ç–æ–¥ 3: —á–µ—Ä–µ–∑ fuser (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
              if command -v fuser >/dev/null 2>&1; then
                FUSER_PIDS=$(sudo fuser $PORT/tcp 2>/dev/null | awk '{print $NF}' || true)
                if [ -n "$FUSER_PIDS" ]; then
                  PIDS="$PIDS $FUSER_PIDS"
                fi
              fi
              # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
              UNIQUE_PIDS=$(echo $PIDS | tr ' ' '\n' | sort -u | tr '\n' ' ')
              if [ -n "$UNIQUE_PIDS" ]; then
                echo "   –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É $PORT: $UNIQUE_PIDS"
                for PID in $UNIQUE_PIDS; do
                  sudo kill -9 $PID 2>/dev/null || true
                done
              fi
            done
            sleep 3
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–≤–æ–±–æ–¥–Ω—ã
            for PORT in 3001 8001; do
              if sudo ss -ltnp 2>/dev/null | grep -q ":$PORT"; then
                echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç $PORT –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç, –ø—ã—Ç–∞–µ–º—Å—è –µ—â–µ —Ä–∞–∑..."
                sudo fuser -k $PORT/tcp 2>/dev/null || true
                sleep 2
              fi
            done
            echo "‚úÖ –ü–æ—Ä—Ç—ã –æ—á–∏—â–µ–Ω—ã"
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º .env —Ñ–∞–π–ª
            echo "üìù –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º .env —Ñ–∞–π–ª..."
            if [ ! -f "$BACKEND_DIR/.env" ]; then
              SECRET_KEY=$(sudo -u www-data venv/bin/python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')
              sudo -u www-data bash -c "printf 'SECRET_KEY=%s\nDEBUG=False\nALLOWED_HOSTS=temis.ooo,api.temis.ooo,localhost,127.0.0.1\nDATABASE_URL=mysql://temis:temis_password@127.0.0.1:3306/temisdb\nUSE_SQLITE=False\n' \"\$SECRET_KEY\" > $BACKEND_DIR/.env" SECRET_KEY="$SECRET_KEY"
              sudo chmod 600 $BACKEND_DIR/.env
              echo "‚úÖ .env —Å–æ–∑–¥–∞–Ω (MySQL)"
            elif grep -q "DATABASE_URL.*sqlite" "$BACKEND_DIR/.env" 2>/dev/null; then
              OLD_SECRET=$(grep "^SECRET_KEY=" "$BACKEND_DIR/.env" | cut -d= -f2- | sed "s/^['\"]//;s/['\"]$//")
              [ -z "$OLD_SECRET" ] && OLD_SECRET=$(sudo -u www-data venv/bin/python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')
              sudo -u www-data bash -c "printf 'SECRET_KEY=%s\nDEBUG=False\nALLOWED_HOSTS=temis.ooo,api.temis.ooo,localhost,127.0.0.1\nDATABASE_URL=mysql://temis:temis_password@127.0.0.1:3306/temisdb\nUSE_SQLITE=False\n' \"\$OLD_SECRET\" > $BACKEND_DIR/.env" OLD_SECRET="$OLD_SECRET"
              echo "‚úÖ .env –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ MySQL"
            else
              echo "‚úÖ .env —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            fi
            
            # –°–æ–∑–¥–∞—ë–º MySQL –ë–î –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            DATABASE_URL=$(grep "^DATABASE_URL=" "$BACKEND_DIR/.env" | cut -d= -f2- | sed "s/^['\"]//;s/['\"]$//")
            if echo "$DATABASE_URL" | grep -q "^mysql" && command -v mysql >/dev/null 2>&1; then
              echo "üê¨ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MySQL –ë–î..."
              DB_USER=$(echo "$DATABASE_URL" | sed -nE 's|mysql://([^:]+):.*|\1|p')
              DB_PASS=$(echo "$DATABASE_URL" | sed -nE 's|mysql://[^:]+:([^@]+)@.*|\1|p')
              DB_NAME=$(echo "$DATABASE_URL" | sed -nE 's|mysql://[^/]+/([^?]+).*|\1|p')
              if [ -n "$DB_USER" ] && [ -n "$DB_NAME" ]; then
                sudo mysql -e "CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>/dev/null || true
                sudo mysql -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASS}';" 2>/dev/null || true
                sudo mysql -e "GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'%';" 2>/dev/null || true
                sudo mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true
                echo "‚úÖ MySQL –ë–î –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
            fi
            fi
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
            sudo -u www-data venv/bin/python manage.py migrate --noinput || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π"
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
            echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É Django..."
            sudo -u www-data venv/bin/python manage.py collectstatic --noinput || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ collectstatic"
            
            # Frontend: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .next/standalone –∏ .next/static
            echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º Frontend (standalone —Ä–µ–∂–∏–º)..."
            cd $FRONTEND_DIR
            
            # –ö–†–ò–¢–ò–ß–ù–û: –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ Next.js –≤ standalone —Ä–µ–∂–∏–º–µ
            if [ -d ".next/standalone/.next" ] && [ -d ".next/static" ]; then
              echo "üîó –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
              cd .next/standalone/.next
              sudo rm -rf static 2>/dev/null || true
              sudo ln -sf ../../static static
              echo "‚úÖ –°–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω: .next/standalone/.next/static -> ../../static"
              cd $FRONTEND_DIR
            else
              echo "‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏–º–ª–∏–Ω–∫–∞"
            fi
            
            if [ ! -d ".next/standalone" ]; then
              echo "‚ö†Ô∏è  .next/standalone –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
            if [ ! -d ".next/static" ]; then
              echo "‚ö†Ô∏è  .next/static –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              echo "–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞!"
              exit 1
            fi
            
            # –í standalone —Ä–µ–∂–∏–º–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ .next/standalone
            # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ server.js
            if [ ! -f ".next/standalone/server.js" ]; then
              echo "‚ö†Ô∏è  server.js –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ standalone!"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã
            STATIC_COUNT=$(find .next/static -type f | wc -l)
            if [ "$STATIC_COUNT" -eq 0 ]; then
              echo "‚ö†Ô∏è  –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ .next/static!"
              exit 1
            fi
            echo "‚úÖ Frontend –≥–æ—Ç–æ–≤ (standalone —Ä–µ–∂–∏–º, –Ω–∞–π–¥–µ–Ω–æ $STATIC_COUNT —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤)"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∞–π–ª–∞–º
            echo "üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∞–π–ª–∞–º..."
            sudo chown -R www-data:www-data .next/static
            sudo find .next/static -type d -exec chmod 755 {} \;
            sudo find .next/static -type f -exec chmod 644 {} \;
            echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            # –°–æ–∑–¥–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            echo "‚öôÔ∏è  –°–æ–∑–¥–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å—ã..."
            set +e
            
            if ! systemctl list-unit-files | grep -q temis-backend; then
              echo "üì¶ –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å temis-backend..."
              sudo bash -c 'cat > /etc/systemd/system/temis-backend.service' << 'SERVICE_EOF' 2>/dev/null
            [Unit]
            Description=Temis Django Backend
            After=network.target

            [Service]
            Type=simple
            User=www-data
            WorkingDirectory=/var/www/temis/backend
            Environment="PATH=/var/www/temis/backend/venv/bin"
            EnvironmentFile=-/var/www/temis/backend/.env
            ExecStart=/var/www/temis/backend/venv/bin/gunicorn \
                --bind 127.0.0.1:8001 \
                --workers 1 \
                --threads 2 \
                --timeout 120 \
                --worker-class gthread \
                --max-requests 1000 \
                --max-requests-jitter 50 \
                --access-logfile /var/log/temis-backend-access.log \
                --error-logfile /var/log/temis-backend-error.log \
                config.wsgi:application
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            SERVICE_EOF
              sudo systemctl daemon-reload
              sudo systemctl enable temis-backend
              echo "‚úÖ –°–µ—Ä–≤–∏—Å temis-backend —Å–æ–∑–¥–∞–Ω –∏ –≤–∫–ª—é—á–µ–Ω"
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å temis-frontend
            echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å temis-frontend..."
            sudo bash -c 'cat > /etc/systemd/system/temis-frontend.service' << 'SERVICE_EOF' 2>/dev/null
            [Unit]
            Description=Temis Next.js Frontend
            After=network.target

            [Service]
            Type=simple
            User=www-data
            WorkingDirectory=/var/www/temis/frontend/.next/standalone
            Environment=NODE_ENV=production
            Environment=PORT=3001
            ExecStart=/usr/bin/node /var/www/temis/frontend/.next/standalone/server.js
            Restart=always
            RestartSec=10
            StandardOutput=journal
            StandardError=journal

            [Install]
            WantedBy=multi-user.target
            SERVICE_EOF
            sudo systemctl daemon-reload
            sudo systemctl enable temis-frontend
            echo "‚úÖ –°–µ—Ä–≤–∏—Å temis-frontend –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –≤–∫–ª—é—á–µ–Ω"
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            if systemctl list-unit-files | grep -q temis-backend; then
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
              echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç 8001 —Å–≤–æ–±–æ–¥–µ–Ω –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º..."
              if sudo ss -ltnp 2>/dev/null | grep -q ":8001"; then
                echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç 8001 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç, –æ—á–∏—â–∞–µ–º..."
                PIDS=$(sudo ss -ltnp 2>/dev/null | awk '/:8001/' | sed -nE 's/.*pid=([0-9]+).*/\1/p' | sort -u)
                if [ -n "$PIDS" ]; then
                  echo "$PIDS" | xargs sudo kill -9 2>/dev/null || true
                  sleep 2
                fi
              fi
              sudo systemctl restart temis-backend
              sleep 3
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
              if systemctl is-active --quiet temis-backend; then
                echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
              else
                echo "‚ö†Ô∏è  Backend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
                sudo systemctl status temis-backend --no-pager -l | head -20
                # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                sleep 2
                sudo systemctl start temis-backend
                sleep 3
                if systemctl is-active --quiet temis-backend; then
                  echo "‚úÖ Backend –∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏"
                else
                  echo "‚ùå Backend –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å"
                fi
              fi
            fi
            
            if systemctl list-unit-files | grep -q temis-frontend; then
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ—Ä—Ç 3001 —Å–≤–æ–±–æ–¥–µ–Ω –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
              echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç 3001 —Å–≤–æ–±–æ–¥–µ–Ω –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
              if sudo ss -ltnp 2>/dev/null | grep -q ":3001"; then
                echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç 3001 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç, –æ—á–∏—â–∞–µ–º..."
                PIDS=$(sudo ss -ltnp 2>/dev/null | awk '/:3001/' | sed -nE 's/.*pid=([0-9]+).*/\1/p' | sort -u)
                if [ -n "$PIDS" ]; then
                  echo "$PIDS" | xargs sudo kill -9 2>/dev/null || true
                  sleep 2
                fi
              fi
              
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω
              if [ -d "$FRONTEND_DIR/.next/standalone/.next" ] && [ -d "$FRONTEND_DIR/.next/static" ]; then
                echo "üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
                if [ ! -L "$FRONTEND_DIR/.next/standalone/.next/static" ]; then
                  echo "   –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫..."
                  cd "$FRONTEND_DIR/.next/standalone/.next"
                  sudo rm -rf static 2>/dev/null || true
                  sudo ln -sf ../../static static
                  cd "$FRONTEND_DIR"
                  echo "   ‚úÖ –°–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω"
                else
                  echo "   ‚úÖ –°–∏–º–ª–∏–Ω–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                fi
              fi
              
              sudo systemctl restart temis-frontend
              sleep 5
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
              if systemctl is-active --quiet temis-frontend; then
                echo "‚úÖ Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
              else
                echo "‚ö†Ô∏è  Frontend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
                sudo systemctl status temis-frontend --no-pager -l | head -30
                echo "üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:"
                sudo journalctl -u temis-frontend -n 50 --no-pager || true
                echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ server.js..."
                if [ -f "$FRONTEND_DIR/.next/standalone/server.js" ]; then
                  echo "   ‚úÖ –§–∞–π–ª server.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                  ls -la "$FRONTEND_DIR/.next/standalone/server.js"
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
                  sudo chown -R www-data:www-data "$FRONTEND_DIR/.next"
                  echo "üîç –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏..."
                  cd "$FRONTEND_DIR/.next/standalone"
                  sudo -u www-data /usr/bin/node server.js --help 2>&1 | head -10 || true
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
                  sudo -u www-data env | grep -E "(NODE_ENV|PORT|NEXT_PUBLIC)" || true
                else
                  echo "   ‚ùå –§–∞–π–ª server.js –ù–ï –Ω–∞–π–¥–µ–Ω!"
                  echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
                  ls -la "$FRONTEND_DIR/.next/standalone/" || true
                fi
                # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                sleep 3
                sudo systemctl start temis-frontend
                sleep 5
                if systemctl is-active --quiet temis-frontend; then
                  echo "‚úÖ Frontend –∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏"
                else
                  echo "‚ùå Frontend –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å"
                  echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
                  sudo journalctl -u temis-frontend -n 30 --no-pager || true
                fi
              fi
            fi
            set -e
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
            echo "üåê –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx..."
            if [ -f "$DEPLOY_DIR/deploy/configs/nginx/temis.conf" ]; then
              echo "üìã –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx..."
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
              echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è letsencrypt
              if [ -d "/etc/letsencrypt/live" ]; then
                echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /etc/letsencrypt/live —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ /etc/letsencrypt/live:"
                sudo ls -la /etc/letsencrypt/live/ || true
              else
                echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /etc/letsencrypt/live –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              fi
              
              SSL_TEMIS_EXISTS=false
              SSL_API_EXISTS=false
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º temis.ooo (–ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ sudo –¥–ª—è –¥–æ—Å—Ç—É–ø–∞)
              if sudo test -f "/etc/letsencrypt/live/temis.ooo/fullchain.pem" && sudo test -f "/etc/letsencrypt/live/temis.ooo/privkey.pem"; then
                SSL_TEMIS_EXISTS=true
                echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è temis.ooo –Ω–∞–π–¥–µ–Ω"
                sudo ls -lh /etc/letsencrypt/live/temis.ooo/fullchain.pem /etc/letsencrypt/live/temis.ooo/privkey.pem 2>/dev/null || true
              else
                echo "‚ö†Ô∏è  SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è temis.ooo –Ω–µ –Ω–∞–π–¥–µ–Ω"
                if sudo test -d "/etc/letsencrypt/live/temis.ooo"; then
                  echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
                  sudo ls -la /etc/letsencrypt/live/temis.ooo/ || true
                fi
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º api.temis.ooo
              if sudo test -f "/etc/letsencrypt/live/api.temis.ooo/fullchain.pem" && sudo test -f "/etc/letsencrypt/live/api.temis.ooo/privkey.pem"; then
                SSL_API_EXISTS=true
                echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è api.temis.ooo –Ω–∞–π–¥–µ–Ω"
                sudo ls -lh /etc/letsencrypt/live/api.temis.ooo/fullchain.pem /etc/letsencrypt/live/api.temis.ooo/privkey.pem 2>/dev/null || true
              else
                echo "‚ö†Ô∏è  SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è api.temis.ooo –Ω–µ –Ω–∞–π–¥–µ–Ω"
                if sudo test -d "/etc/letsencrypt/live/api.temis.ooo"; then
                  echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
                  sudo ls -la /etc/letsencrypt/live/api.temis.ooo/ || true
                fi
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ certbot
              if command -v certbot >/dev/null 2>&1; then
                echo "‚úÖ certbot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(certbot --version)"
              else
                echo "‚ö†Ô∏è  certbot –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ certbot:"
                echo "   sudo apt-get update && sudo apt-get install -y certbot python3-certbot-nginx"
              fi
              
              # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑ SSL –µ—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–µ—Ç
              if [ "$SSL_TEMIS_EXISTS" = false ] || [ "$SSL_API_EXISTS" = false ]; then
                echo "üìù –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
                sudo bash -c 'cat > /etc/nginx/sites-available/temis.conf' << 'NGINX_EOF'
            # HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è temis.ooo (–≤—Ä–µ–º–µ–Ω–Ω–∞—è, –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è SSL)
            server {
                listen 80;
                listen [::]:80;
                server_name temis.ooo;

                # –õ–æ–≥–∏
                access_log /var/log/nginx/temis_access.log;
                error_log /var/log/nginx/temis_error.log;

                # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
                client_max_body_size 20M;

                # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Next.js
                location / {
                    proxy_pass http://localhost:3001;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                    proxy_read_timeout 300s;
                    proxy_connect_timeout 75s;
                }

                # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã Next.js - –ö–†–ò–¢–ò–ß–ù–û: –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º –Ω–∞ –ø–æ—Ä—Ç 3001
                location /_next/ {
                    proxy_pass http://localhost:3001;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                    expires 1y;
                    add_header Cache-Control "public, max-age=31536000, immutable";
                }
                
                # Favicon –∏ –¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑ public
                location ~ ^/(favicon\.ico|robots\.txt|sitemap\.xml)$ {
                    proxy_pass http://localhost:3001;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    expires 7d;
                    add_header Cache-Control "public";
                }
                
                # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ API (–Ω–∞–ø—Ä—è–º—É—é –Ω–∞ backend)
                location /media/ {
                    proxy_pass http://127.0.0.1:8001/media/;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    expires 30d;
                    add_header Cache-Control "public";
                }
            }

            # HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è api.temis.ooo (–≤—Ä–µ–º–µ–Ω–Ω–∞—è, –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è SSL)
            server {
                listen 80;
                listen [::]:80;
                server_name api.temis.ooo;

                # –õ–æ–≥–∏
                access_log /var/log/nginx/temis-api_access.log;
                error_log /var/log/nginx/temis-api_error.log;

                # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
                client_max_body_size 20M;

                # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã Django
                location /static/ {
                    alias /var/www/temis/backend/staticfiles/;
                    expires 30d;
                    add_header Cache-Control "public";
                }

                # –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã Django
                location /media/ {
                    alias /var/www/temis/backend/media/;
                    expires 30d;
                    add_header Cache-Control "public";
                }

                # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Django
                location / {
                    proxy_pass http://127.0.0.1:8001;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 300s;
                    proxy_connect_timeout 75s;
                }
            }
            NGINX_EOF
              else
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å SSL
                sudo cp $DEPLOY_DIR/deploy/configs/nginx/temis.conf /etc/nginx/sites-available/temis.conf
              fi
              
              # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
              sudo rm -f /etc/nginx/sites-enabled/temis /etc/nginx/sites-enabled/temis.production.conf 2>/dev/null || true
              
              # –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Å–∏–º–ª–∏–Ω–∫
              sudo rm -f /etc/nginx/sites-enabled/temis.conf
              echo "üîó –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è temis.conf..."
              sudo ln -s /etc/nginx/sites-available/temis.conf /etc/nginx/sites-enabled/temis.conf
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
              if sudo nginx -t; then
                echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
              else
                echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
                exit 1
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è temis.conf –∞–∫—Ç–∏–≤–Ω–∞ –∏ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
              echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
              echo "–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
              sudo ls -la /etc/nginx/sites-enabled/ | grep -E "(temis|estenomada)" || true
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ temis.conf –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º (–∞–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)
              # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å estenomada, temis –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
              if [ -f "/etc/nginx/sites-enabled/estenomada" ] || [ -f "/etc/nginx/sites-enabled/estenomada.conf" ]; then
                echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è estenomada - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç..."
                echo "   Nginx –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ"
                echo "   temis.conf –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ—Å–ª–µ estenomada –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞"
              fi
            else
              echo "‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            fi
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –∫—ç—à)
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)..."
            sudo systemctl restart nginx
            sleep 2
            if sudo systemctl is-active --quiet nginx; then
              echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ Nginx!"
              sudo systemctl status nginx --no-pager -l | head -20
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ frontend —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 3001
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å temis-frontend..."
            if systemctl is-active --quiet temis-frontend; then
              echo "   ‚úÖ temis-frontend –∑–∞–ø—É—â–µ–Ω"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
              if sudo netstat -tlnp 2>/dev/null | grep -q ":3001" || sudo ss -tlnp 2>/dev/null | grep -q ":3001"; then
                echo "   ‚úÖ –ü–æ—Ä—Ç 3001 —Å–ª—É—à–∞–µ—Ç—Å—è"
                sudo netstat -tlnp 2>/dev/null | grep ":3001" || sudo ss -tlnp 2>/dev/null | grep ":3001"
              else
                echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç 3001 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è!"
                echo "   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º temis-frontend..."
                sudo systemctl restart temis-frontend
                sleep 3
                if sudo netstat -tlnp 2>/dev/null | grep -q ":3001" || sudo ss -tlnp 2>/dev/null | grep -q ":3001"; then
                  echo "   ‚úÖ –ü–æ—Ä—Ç 3001 —Ç–µ–ø–µ—Ä—å —Å–ª—É—à–∞–µ—Ç—Å—è"
                else
                  echo "   ‚ùå –ü–æ—Ä—Ç 3001 –≤—Å–µ –µ—â–µ –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è!"
                  sudo systemctl status temis-frontend --no-pager -l | head -20
                fi
              fi
            else
              echo "   ‚ùå temis-frontend –ù–ï –∑–∞–ø—É—â–µ–Ω!"
              echo "   –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å..."
              sudo systemctl start temis-frontend
              sleep 3
              if systemctl is-active --quiet temis-frontend; then
                echo "   ‚úÖ temis-frontend –∑–∞–ø—É—â–µ–Ω"
              else
                echo "   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å temis-frontend!"
                sudo systemctl status temis-frontend --no-pager -l | head -20
              fi
            fi
            
            # –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
            echo "üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
            if [ -d "$FRONTEND_DIR/.next/static" ]; then
              STATIC_FILES=$(find $FRONTEND_DIR/.next/static -type f | head -5)
              echo "   –ù–∞–π–¥–µ–Ω–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (–ø–µ—Ä–≤—ã–µ 5):"
              for file in $STATIC_FILES; do
                echo "   - $file ($(sudo ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'))"
              done
            else
              echo "   ‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next/static –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ frontend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3001
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å frontend –Ω–∞ –ø–æ—Ä—Ç—É 3001:"
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/_next/static/css/ 2>/dev/null | grep -qE "200|404|403"; then
              echo "   ‚úÖ Frontend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3001"
            else
              echo "   ‚ö†Ô∏è  Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3001 –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
              echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ temis-frontend..."
              sudo journalctl -u temis-frontend -n 20 --no-pager || true
            fi
            
            # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ api.temis.ooo –ù–ï –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç
            echo "üîç –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é api.temis.ooo..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx –Ω–∞ –Ω–∞–ª–∏—á–∏–µ api.temis.ooo
            echo "–ü–æ–∏—Å–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–ª—è api.temis.ooo:"
            sudo grep -r "server_name.*api.temis.ooo" /etc/nginx/sites-enabled/ || echo "   –ù–µ –Ω–∞–π–¥–µ–Ω–æ"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞ –∫–∞–∫–æ–π –ø–æ—Ä—Ç –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è api.temis.ooo
            API_CONFIG=$(sudo grep -A 20 "server_name.*api.temis.ooo" /etc/nginx/sites-enabled/* 2>/dev/null | grep -A 5 "location /" | grep "proxy_pass" | head -1)
            if [ -n "$API_CONFIG" ]; then
              echo "–ù–∞–π–¥–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è proxy_pass –¥–ª—è api.temis.ooo:"
              echo "   $API_CONFIG"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
              if echo "$API_CONFIG" | grep -q ":8001"; then
                echo "   ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç 8001 (temis-backend)"
              elif echo "$API_CONFIG" | grep -q ":8000"; then
                echo "   ‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç 8000 (estenomada-backend)!"
                echo "   –≠—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é."
              else
                echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Ä—Ç"
              fi
            else
              echo "   ‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è proxy_pass –¥–ª—è api.temis.ooo –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ temis-backend –∑–∞–ø—É—â–µ–Ω
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å temis-backend..."
            if systemctl is-active --quiet temis-backend; then
              echo "   ‚úÖ temis-backend –∑–∞–ø—É—â–µ–Ω"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
              if sudo netstat -tlnp 2>/dev/null | grep -q ":8001" || sudo ss -tlnp 2>/dev/null | grep -q ":8001"; then
                echo "   ‚úÖ –ü–æ—Ä—Ç 8001 —Å–ª—É—à–∞–µ—Ç—Å—è"
              else
                echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç 8001 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è!"
              fi
            else
              echo "   ‚ùå temis-backend –ù–ï –∑–∞–ø—É—â–µ–Ω!"
              echo "   –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å..."
              sudo systemctl start temis-backend || echo "   –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sudo systemctl status temis-backend --no-pager -l | head -10 || true
            sudo systemctl status temis-frontend --no-pager -l | head -10 || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Este N√≥mada –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Este N√≥mada –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç..."
            if systemctl is-active --quiet estenomada-frontend; then
              echo "‚úÖ Este N√≥mada frontend —Ä–∞–±–æ—Ç–∞–µ—Ç"
            fi
            if systemctl is-active --quiet estenomada-backend; then
              echo "‚úÖ Este N√≥mada backend —Ä–∞–±–æ—Ç–∞–µ—Ç"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º show_title –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º show_title –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü..."
            cd $BACKEND_DIR
            sudo -u www-data venv/bin/python manage.py check_show_title 2>&1 | head -50 || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É show_title"
            
            echo "‚úÖ –î–µ–ø–ª–æ–π Temis –∑–∞–≤–µ—Ä—à–µ–Ω!"
      
      - name: Send Telegram notification on success
        if: success()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–º–∏—Ç–µ
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            COMMIT_MESSAGE="${{ github.event.workflow_run.head_commit.message }}"
            COMMIT_AUTHOR="${{ github.event.workflow_run.head_commit.author.name }}"
          else
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          fi
          
          # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ (–ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤)
          COMMIT_MESSAGE_SHORT=$(echo "$COMMIT_MESSAGE" | head -c 100)
          if [ ${#COMMIT_MESSAGE} -gt 100 ]; then
            COMMIT_MESSAGE_SHORT="${COMMIT_MESSAGE_SHORT}..."
          fi
          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è URL
          COMMIT_MESSAGE_ESCAPED=$(echo "$COMMIT_MESSAGE_SHORT" | sed 's/&/%26/g; s/#/%23/g; s/+/%2B/g; s/ /%20/g')
          
          MESSAGE="‚úÖ <b>–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüåê –î–æ–º–µ–Ω: temis.ooo%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A%0Aüìù <b>–ö–æ–º–º–∏—Ç:</b>%0A${COMMIT_MESSAGE_ESCAPED}%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA}\">${COMMIT_SHA:0:7}</a>%0A%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
      
      - name: Send Telegram notification on failure
        if: failure()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN || '8519804617:AAFDdXQOMb9EqfdJViVfBFS5ReLoP9oHYnQ' }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            exit 0
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–º–∏—Ç–µ
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            COMMIT_MESSAGE="${{ github.event.workflow_run.head_commit.message }}"
            COMMIT_AUTHOR="${{ github.event.workflow_run.head_commit.author.name }}"
          else
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          fi
          
          # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ (–ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤)
          COMMIT_MESSAGE_SHORT=$(echo "$COMMIT_MESSAGE" | head -c 100)
          if [ ${#COMMIT_MESSAGE} -gt 100 ]; then
            COMMIT_MESSAGE_SHORT="${COMMIT_MESSAGE_SHORT}..."
          fi
          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è URL
          COMMIT_MESSAGE_ESCAPED=$(echo "$COMMIT_MESSAGE_SHORT" | sed 's/&/%26/g; s/#/%23/g; s/+/%2B/g; s/ /%20/g')
          
          MESSAGE="‚ùå <b>–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π</b>%0A%0Aüì¶ –ü—Ä–æ–µ–∫—Ç: Temis%0Aüåê –î–æ–º–µ–Ω: temis.ooo%0Aüîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0Aüåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}%0Aüë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A%0Aüìù <b>–ö–æ–º–º–∏—Ç:</b>%0A${COMMIT_MESSAGE_ESCAPED}%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA}\">${COMMIT_SHA:0:7}</a>%0A%0A‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π%0Aüîó <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true || true
      
      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz

