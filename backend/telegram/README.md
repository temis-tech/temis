# Интеграция с Telegram ботом

## Описание

Интеграция позволяет:
1. **Получать уведомления в Telegram** о событиях на сайте:
   - При прохождении анкеты
   - При новой записи
   - При начале отображения приветственного баннера
   - При завершении отображения приветственного баннера

2. **Автоматически создавать элементы каталога** из постов в Telegram канале:
   - При создании нового поста в канале автоматически создается элемент каталога на указанной странице каталога
   - Изображения из поста загружаются и используются в элементе каталога
   - Работает через webhook в реальном времени

## Настройка

### 1. Создание бота

1. Найдите [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный токен

### 2. Настройка в админке Django

1. Перейдите в админку Django
2. Откройте раздел "Настройки Telegram бота"
3. Заполните:
   - **Токен бота** - токен, полученный от @BotFather (по умолчанию уже заполнен)
   - **Активен** - включите бота
   - Настройте уведомления (какие события должны отправлять уведомления)

### 3. Установка webhook

После настройки бота в админке, установите webhook командой:

```bash
python manage.py setup_webhook
```

Или вручную укажите URL:

```bash
python manage.py setup_webhook --url https://your-domain.com/api/telegram/webhook/
```

### 4. Активация бота пользователем

1. Пользователь должен найти вашего бота в Telegram
2. Отправить команду `/start` или `/help`
3. В админке Django появится запись о новом пользователе в разделе "Пользователи Telegram"

### 5. Настройка администраторов

1. Перейдите в раздел "Пользователи Telegram" в админке
2. Найдите пользователя, который должен получать уведомления
3. Отметьте галочку **"Админ"**
4. Сохраните

**Важно:** Только пользователи с отмеченной галочкой "Админ" будут получать уведомления.

## Периодическая проверка баннеров

Для отправки уведомлений о начале/завершении отображения баннеров, добавьте в cron задачу:

```bash
* * * * * cd /path/to/project/backend && source venv/bin/activate && python manage.py check_banners
```

Эта команда будет проверять баннеры каждую минуту и отправлять уведомления при необходимости.

## Структура

- `models.py` - модели для настроек бота и пользователей
- `admin.py` - настройки админки
- `bot.py` - логика работы с Telegram API
- `views.py` - обработчик webhook
- `signals.py` - сигналы для отправки уведомлений
- `urls.py` - URL маршруты
- `management/commands/` - команды для управления ботом

## API

### Webhook URL

`POST /api/telegram/webhook/` - принимает обновления от Telegram

### Management команды

- `python manage.py setup_webhook` - установить webhook
- `python manage.py check_banners` - проверить баннеры и отправить уведомления
- `python manage.py sync_telegram_channel` - синхронизировать посты из канала (опционально, для получения пропущенных постов)

## Синхронизация с Telegram каналом

### Настройка

1. **Добавьте бота в канал как администратора:**
   - Откройте настройки канала в Telegram
   - Перейдите в "Администраторы"
   - Добавьте вашего бота как администратора

2. **Настройте синхронизацию в админке Django:**
   - Перейдите в "Настройки Telegram бота"
   - Включите "Включить синхронизацию с каналом"
   - Укажите "Username канала" (например, `@channel_name`) или ID канала
   - **Обязательно выберите "Страница каталога"** - страницу, в которую будут создаваться элементы
   - ID канала будет заполнен автоматически при первой синхронизации

3. **Убедитесь, что webhook установлен:**
   - Webhook необходим для получения постов в реальном времени
   - Используйте кнопку "Установить webhook" в админке

### Как это работает

- При создании нового поста в канале Telegram отправляет обновление на webhook
- Система автоматически:
  - Извлекает текст поста и хештеги
  - Определяет настройки для хештега (если хештег настроен)
  - Загружает изображение (если есть)
  - Создает элемент каталога на указанной странице каталога с настройками из хештега
  - Использует текст поста (без хештегов) как описание элемента
  - Использует изображение из поста в карточке и на странице элемента

### Настройка хештегов

Система поддерживает автоматическую категоризацию постов по хештегам. Для каждого хештега можно настроить:
- **Страницу каталога** - куда будут создаваться элементы
- **Ширину элемента** - узкая, средняя, широкая или на всю ширину
- **Настройки кнопки** - тип кнопки (запись, анкета, внешняя ссылка или без кнопки)
- **Порядок** - порядок сортировки элементов в каталоге

#### Как настроить хештеги:

1. В админке перейдите в раздел **"Настройки хештегов"**
2. Создайте новую настройку:
   - Укажите хештег (без символа #, например: `новости`, `статья`)
   - Выберите страницу каталога
   - Настройте параметры элемента (ширина, кнопка и т.д.)
3. В постах Telegram используйте соответствующий хештег (например: `#новости`, `#статья`)
4. Система автоматически создаст элемент каталога в нужном каталоге с указанными настройками

**Пример:**
- Хештег: `новости` → Каталог "Новости" → Элементы создаются с шириной "full" и кнопкой "Подробнее"
- Хештег: `статья` → Каталог "Статьи" → Элементы создаются с шириной "medium" и без кнопки

**Важно:**
- Если в посте нет хештега или хештег не настроен, пост будет пропущен
- Хештеги регистронезависимы (#Новости = #новости = #НОВОСТИ)
- Если в посте несколько хештегов, используется первый найденный активный
- Хештеги удаляются из текста поста перед созданием элемента каталога

### Периодическая синхронизация (опционально)

Для получения постов, которые могли быть пропущены, можно добавить в cron:

```bash
0 */6 * * * cd /path/to/project/backend && source venv/bin/activate && python manage.py sync_telegram_channel --limit 20
```

Эта команда будет проверять последние 20 постов каждые 6 часов.

